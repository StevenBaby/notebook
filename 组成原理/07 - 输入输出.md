# 07 - 输入输出

计算机系统的I/O体系结构是系统与外部世界的接口。这种体系结构提供了一种控制计算机与外部世界交互的系统化方式，并向操作系统提供有效地管理I/O行为的必要信息。

有三种基本的 I/O 技术：

- 编程式 I/O：即在请求 I/O 操作的程序的直接和连续的控制下发生的 I/O 操作
- 中断驱动式 I/O：即程序发出I/O命令后继续执行，直到被I/O硬件中断，通知它 I/O 操作完成
- 直接存储器存取 DMA：即一个专门的 I/O处理器接管 I/O 操作的控制，在I/O设备与存储器之间直接传送大量数据。

外部 I/O 接口的两个重要实例式： FireWire 和 Infiniband

一个 I/O模块不是简单地将设备连接到系统总线的一组机械连接器，而是包含了执行设备与系统总线之间通信功能的逻辑。

不能直接把外设连接到系统总线上，因为：

- 各种外设的操作方法式不同的，将控制一定范围的外设的必要逻辑合并到某个处理器内是不现实的。
- 外设的数据传送速度一般比存储器或处理器慢得多，因此，使用高速的系统总线直接与外设通信时不切实际的
- 某些外设的数据传送速率，比存储器或处理器块，同样，若不适当管理，则速度失配将导致无效
- 外设使用的数据格式和字长度通常与处理器不同

IO模块，有两大主要功能：

- 通过系统总线或中央交换器与处理器和存储器连接
- 通过专用数据线与一个或多个外设连接

## 外部设备

IO操作时通过各种外部设备来完成的，这些外部设备提供了外部环境和计算机之间交换数据的方式。外部设备通过I/O模块的链接而与计算机相连，这种链接可以实现IO模块与外部设备之间的控制信息，状态信息和数据信息的交换。连接到IO模块的外部设备常被称为 **外围设备** 简称 **外设**

广义上可以将外部设备分为3类：

- 人可读设备：适用于与计算机用户通信
- 机器可读设备：适用于与设备通信
- 通信设备：适用于与远程设备通信

## I/O 模块

I/O模块的主要功能或需求分为控制和定时、处理器通信、设备通信、数据缓冲，检错几种。

控制从外设到处理器的数据传送包括了以下几个步骤：

- 处理器查询 I/O模块，以检验所连接设备的状态
- I/O模块返回设备状态
- 如果设备运转正常，并准备就绪，则处理器通过向IO模块发出一条命令，请求数据传送。
- I/O模块获得来自外设的一个数据单元
- 数据从I/O模块传送到处理器

如果系统采用总线，则每次处理器和IO模块之间的交互作用都会涉及一次或者几次总线仲裁

IO模块必须与处理器及外设进行通信，处理器通信包括：

- 命令译码
- 数据
- 状态报告
- 地址识别

IO模块必须能进行设备通信

IO模块的一个基本功能时数据缓冲

IO模块通常还需要负责检错

## 编程式 I/O

I/O操作可采用三种技术，对于编程式IO，数据在处理器和IO模块之间交换，处理器通过执行程序来直接控制IO操作，包括检测设备状态、发送读写命令以及传送数据。当处理器发送一条命令到IO模块时，它必须等待，直到IO操作完成。

IO命令：

- 控制命令：用于激活外设并告诉它要做什么
- 测试命令：用于测试IO模块及其相关的各种状态条件
- 读命令：使IO模块从外设获得一个数据项，并把它存入内部缓冲区，然后处理器可以通过请求IO把数据传送到数据总线以获得该数据项
- 写命令：使IO模块从数据总线获得一个数据项，然后把他传送到外设。

通常，有多个IO设备通过IO模块连接到系统，每个设备有一个唯一的标识符或地址。当处理器发送IO命令时，该命令就包括所需设备的地址。因此，每个IO模块必须对地址线译码，确定命令是否时发送给自己。

当处理器、主存和IO共享一条公共总线时，有两种可能的编址方式：

**存储器映射方式**

存储单元和IO设备有单一的地址空间。处理器将IO模块的状态和数据寄存器看成存储单元一样对待，使用相同的及其指令来访问存储器和IO设备。

**分离式**

IO的地址空间与存储器的地址空间时分离的

对于大部分类型的处理器，有相对多的一组不同指令用于访问存储器。而如果采用分离式IO则只有少数几种IO指令。因此存储器映射式IO的有点式能使用大的指令系统，这样可进行更有效的编程；其缺点式占用了宝贵的内存地址空间，存储器映射式和分离式IO都很常用。

## 中断驱动式IO

编程式IO存在的问题式，处理器必须为IO模块准备接收或传送数据等待很长一段时间。在等待的过程中，处理器必须不断地询问IO模块的状态，因此使整个系统性能严重下降。

处理器发送一个IO命令到模块，然后去处理其他有用的工作。当IO模块准备和处理器交换数据时，它中断处理器以请求服务。然后处理器执行数据传送，最后恢复它原先的处理工作。

中断驱动式IO消除了空闲的等待，但仍然要耗费处理器很多的时间，因为存储器到IO模块或从IO模块到存储器的每个数据字都必须经过处理器传送。

**中断处理**

- 设备给处理器发送一个中断信号
- 处理器在响应应该中断之前完成当前指令的执行
- 处理器检测中断，确定中断源，并发送一个确认信号给发送中断的设备，允许设备取消中断信号
- 处理器需要准备传送给中断例程。
- 处理器将响应应该中断的中断处理程序的入口地址装入程序计数器。

## 直接存储器存取

DMA在系统总线上增加了一个模块，该DMA模块能够模仿处理器，并确实从处理器那里接管了系统控制工作。它需要通过控制系统总线来管理从存储器输出或输入存储器的数据。为此，DMA模块必须只在处理器不需要总线时占用系统总线，或者必须强制处理器暂时挂起，后一种技术更加通用，称为**周期窃取**，即DMA模块有效的窃取一个总线周期。

处理器希望写数据时，给DMA发送如下信息：

- 通过使用处理器与DMA模块之间的读或写控制线，说明需要的是读还是写操作
- 相应的IO设备地址，经数据线传输
- 读或写操作的存储器起始单元地址，经数据线传输，并被DMA模块存入其地址寄存器中
- 读写操作的字数，经数据线传输，并被DMA模块存入其数据计数寄存器中

## IO通道和处理器

IO功能演变：

- CPU直接控制外设，这主要用于简单的微处理器控制设备
- 增加控制器或IO模块，处理器使用编程式IO而不是中断，使处理器从外设的特殊细节中解脱出来
- 采用与2相同的配置，但使用了中断，处理器不需要浪费时间等待IO操作完成，提高了处理器的工作效率
- IO模块通过DMA直接存取存储器，传输数据不需要处理器的参与，除了在传输的开始和结束时参与以外
- IO模块称为有自主控制权的处理器，有处理IO的专用指令集。
- IO模块带有其局部存储器，成为一台自治的计算机。

从上面的演变过程可以看出，越来越多的IO功能在执行时不需要CPU参与，CPU日益从IO相关的工作中解放出来，改善了系统性能。

## 参考资料

- [1] 计算机组成与体系结构 [美] William Stallings 著
